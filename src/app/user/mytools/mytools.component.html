<div class="container">
    <div class="left-section">
        @if(tools) {
            <div class="tools-header">
                <div class="left-side"><span>üîç</span> <span>{{ tools.length }}</span> Tools</div>
                <div class="right-side" (click)="addNew()"><fa-icon [icon]="faCirclePlus" matTooltip="Add a new tool!"></fa-icon></div>
            </div>

            @for(tool of tools; track tool.id; let i = $index) {
                <div>
                    @defer (on viewport) {
                        <app-browse-tool-card [object]="tool" [showOwner]="false" (click)="selectTool(i)"></app-browse-tool-card>
                    }
                    @placeholder { 
                        <div class="tool-card-placeholder">
                            <img src="https://wp.angular.love/wp-content/uploads/2024/04/image3.png">
                        </div>
                    }
                </div>
            }
        }
    </div>

    <div class="right-section">
        @if(selectedTool) {
            <div class="settings-container">
                <h2>
                    @if(selectedTool.id > 0) {
                        üî® Edit Your Shared Tool
                    } @else {
                        ü™ö Share A New Tool   
                    }
                </h2>
                <form [formGroup]="settingsForm" (ngSubmit)="onSubmit()">
                    <div class="form-row">
                        <label for="brand">Brand</label>
                        <div class="wide">
                            <div class="field">
                                <mat-form-field class="outline" subscriptSizing="dynamic">
                                    <input matInput id="brand" formControlName="brand" type="text"/>
                                    <mat-error>
                                        Enter a valid value.
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="short_name">Short Name</label>
                        <div class="wide">
                            <div class="field">
                                <mat-form-field class="outline" subscriptSizing="dynamic">
                                    <input matInput id="short_name" formControlName="short_name" type="text"
                                        matTooltip="A brief name e.g. 'Car Jack' or 'Shovel'."/>
                                    <mat-error>
                                        Enter a valid value.
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="name">Name</label>
                        <div class="wide">
                            <div class="field">
                                <mat-form-field class="outline" subscriptSizing="dynamic">
                                    <input matInput id="name" formControlName="name" type="text" matTooltip="The tool's full name."/>
                                    <mat-error>
                                        Enter a valid value.
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        @let brand = settingsForm.get('brand');
                        @let shortName = settingsForm.get('short_name');
                        @let name = settingsForm.get('name');
                        <button type="button" mat-raised-button mat-button [disabled]="!brand?.value || !shortName?.value || !name?.value" (click)="getSuggestions()">Suggest Category & Keywords</button>
                    </div>

                    <div class="form-row">
                        <label for="category">Category</label>
                        <mat-form-field class="outline" appearance="outline" subscriptSizing="dynamic">
                            <mat-select matInput formControlName="category" appearance="outline">
                                <mat-option disabled>Select a category</mat-option>

                                @for(cat of toolCategories; track cat.id; let i = $index) {
                                    <mat-option [value]="cat.id">
                                        <mat-icon fontSet="fa" [fontIcon]="cat.icon"></mat-icon> {{ cat.name }}
                                    </mat-option>
                                }
                            </mat-select>
                            @if (toolCategoryLoading) {
                                <mat-progress-spinner matSuffix
                                    mode="indeterminate"
                                    diameter="32"
                                    color="accent">
                                </mat-progress-spinner>
                            }
                            @if(settingsForm.get('category')?.hasError('required')) {
                                <mat-error>üõ† Please select a category</mat-error>
                            }
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <label for="keywords">Search Keywords</label>
                        <div class="wide" formArrayName="search_terms">
                            @for(keyword of search_terms.controls; track keyword; let i = $index) {                                
                                <div class="field">
                                    <span class="icon">ü°Ü</span>
                                    <mat-form-field class="outline" subscriptSizing="dynamic">
                                        <input matInput id="keyword-{{ i }}" placeholder="Enter up to 5 search keywords" [formControlName]="i">
                                        @if (toolCategoryLoading) {
                                            <mat-progress-spinner matSuffix
                                                mode="indeterminate"
                                                diameter="32"
                                                color="accent">
                                            </mat-progress-spinner>
                                        }
                                        <mat-error>Enter a search term.</mat-error>
                                    </mat-form-field>
                                    @if (search_terms.length < 5) {
                                        <span class="icon"><fa-icon [icon]="faCirclePlus" (click)="addKeyword()" matTooltip="Add a search keyword!"></fa-icon></span>
                                    }
                                    @if (search_terms.length > 1) {
                                        <span class="icon"><fa-icon [icon]="faCircleMinus" (click)="removeKeyword(i)" matTooltip="Remove this search keyword!"></fa-icon></span>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="replacement_cost">Replacement Cost</label>
                        <div class="wide">
                            <div class="field">
                                <mat-form-field class="outline" subscriptSizing="dynamic">
                                <input matInput appCurrencyFormat id="replacement_cost" formControlName="replacement_cost" type="text"
                                    matTooltip="How much will it cost to replace this tool if someone loses or breaks it?"
                                    />
                                    <mat-error>
                                        Enter a valid value.
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>

                    @if(selectedTool.id <= 0) {
                        <div class="form-row">
                            <label for="product_url">Product URL</label>
                            <div class="wide">
                                <div class="field">
                                    <mat-form-field class="outline" subscriptSizing="dynamic">
                                        <input matInput id="product_url" formControlName="product_url" type="text"
                                            matTooltip="A link to where you can find more information about this tool." />
                                        <mat-error>
                                            Enter a valid value.
                                        </mat-error>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="form-row">
                        <label for="photo" class="narrower">Photo</label>
                        @if (this.settingsForm.get('photo')?.value) {
                            <div class="icon" (click)="resetPhoto()" matTooltip="Discard this picture.">
                                <fa-icon [icon]="faTrash"></fa-icon>
                            </div>
                        }
                        @else {
                            <div class="icon blank"><fa-icon [icon]="faTrash"></fa-icon></div>
                        }
                        <input #photoInput id="photo" type="file" (change)="onPhotoSelected($event)" accept="image/*" />
                    </div>

                    @if (photoPreview) {
                    <div class="preview">
                        <img [src]="photoPreview" alt="Photo preview" />
                    </div>
                    }
1: {{settingsForm.dirty}}<br>
2: {{photoChanged}}<br>
3: {{settingsForm.invalid}}<br>
                    <button class="bottom-of-page" mat-raised-button type="submit" [disabled]="(!settingsForm.dirty && !photoChanged) || settingsForm.invalid">Save
                        Changes</button>
                </form>
            </div>
        }
    </div>

</div>